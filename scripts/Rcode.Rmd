---
title: "Experiments"
author: "David Liu"
date: "2025-05-15"
output: pdf_document
---

```{r}
library(dplyr)
library(ggplot2)
library(readr)

# Load the dataset
polls <- read_csv("polls_us_election_2016 (1).csv")

# Fill missing grades with the mode
mode_grade <- polls %>%
  filter(!is.na(grade)) %>%
  count(grade) %>%
  arrange(desc(n)) %>%
  slice(1) %>%
  pull(grade)

polls$grade[is.na(polls$grade)] <- mode_grade

# Actual 2016 state-level outcomes
state_outcomes <- c(
  'U.S.' = 'Clinton',
  'Alabama' = 'Trump', 'Alaska' = 'Trump', 'Arizona' = 'Trump', 'Arkansas' = 'Trump',
  'California' = 'Clinton', 'Colorado' = 'Clinton', 'Connecticut' = 'Clinton',
  'Delaware' = 'Clinton', 'District of Columbia' = 'Clinton', 'Florida' = 'Trump',
  'Georgia' = 'Trump', 'Hawaii' = 'Clinton', 'Idaho' = 'Trump', 'Illinois' = 'Clinton',
  'Indiana' = 'Trump', 'Iowa' = 'Trump', 'Kansas' = 'Trump', 'Kentucky' = 'Trump',
  'Louisiana' = 'Trump', 'Maine' = 'Clinton', 'Maryland' = 'Clinton',
  'Massachusetts' = 'Clinton', 'Michigan' = 'Trump', 'Minnesota' = 'Clinton',
  'Mississippi' = 'Trump', 'Missouri' = 'Trump', 'Montana' = 'Trump',
  'Nebraska' = 'Trump', 'Nevada' = 'Clinton', 'New Hampshire' = 'Clinton',
  'New Jersey' = 'Clinton', 'New Mexico' = 'Clinton', 'New York' = 'Clinton',
  'North Carolina' = 'Trump', 'North Dakota' = 'Trump', 'Ohio' = 'Trump',
  'Oklahoma' = 'Trump', 'Oregon' = 'Clinton', 'Pennsylvania' = 'Trump',
  'Rhode Island' = 'Clinton', 'South Carolina' = 'Trump', 'South Dakota' = 'Trump',
  'Tennessee' = 'Trump', 'Texas' = 'Trump', 'Utah' = 'Trump', 'Vermont' = 'Clinton',
  'Virginia' = 'Clinton', 'Washington' = 'Clinton', 'West Virginia' = 'Trump',
  'Wisconsin' = 'Trump', 'Wyoming' = 'Trump'
)

# Add actual outcome
polls$actual_winner <- state_outcomes[polls$state]

# Predicted winner using adjusted polls
polls$predicted_winner <- ifelse(polls$adjpoll_clinton > polls$adjpoll_trump, "Clinton", "Trump")

# Check correctness of prediction
polls$correct <- polls$predicted_winner == polls$actual_winner

# Compute accuracy by grade
grade_accuracy <- polls %>%
  group_by(grade) %>%
  summarise(
    n = n(),
    correct = sum(correct, na.rm = TRUE),
    accuracy = correct / n
  )

# Order pollster grades in standard grading order
grade_levels <- c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "D-", "F")
grade_accuracy$grade <- factor(grade_accuracy$grade, levels = grade_levels)

# Plot accuracy by grade
ggplot(grade_accuracy, aes(x = grade, y = accuracy)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  ylim(0, 1) +
  labs(
    title = "Which Grade had the Most Accurate Predictions?",
    x = "Pollster Grade",
    y = "Accuracy (Proportion Correct)"
  ) +
  theme_minimal()

```
```{r}
library(dplyr)
library(ggplot2)
library(readr)

# Load the dataset
polls <- read_csv("polls_us_election_2016 (1).csv")

# Fill missing grades with mode
mode_grade <- polls %>% filter(!is.na(grade)) %>% count(grade) %>% arrange(desc(n)) %>% slice(1) %>% pull(grade)
polls$grade[is.na(polls$grade)] <- mode_grade

# Add actual outcomes
state_outcomes <- c(
  'U.S.' = 'Clinton',
  'Alabama' = 'Trump', 'Alaska' = 'Trump', 'Arizona' = 'Trump', 'Arkansas' = 'Trump',
  'California' = 'Clinton', 'Colorado' = 'Clinton', 'Connecticut' = 'Clinton',
  'Delaware' = 'Clinton', 'District of Columbia' = 'Clinton', 'Florida' = 'Trump',
  'Georgia' = 'Trump', 'Hawaii' = 'Clinton', 'Idaho' = 'Trump', 'Illinois' = 'Clinton',
  'Indiana' = 'Trump', 'Iowa' = 'Trump', 'Kansas' = 'Trump', 'Kentucky' = 'Trump',
  'Louisiana' = 'Trump', 'Maine' = 'Clinton', 'Maryland' = 'Clinton',
  'Massachusetts' = 'Clinton', 'Michigan' = 'Trump', 'Minnesota' = 'Clinton',
  'Mississippi' = 'Trump', 'Missouri' = 'Trump', 'Montana' = 'Trump',
  'Nebraska' = 'Trump', 'Nevada' = 'Clinton', 'New Hampshire' = 'Clinton',
  'New Jersey' = 'Clinton', 'New Mexico' = 'Clinton', 'New York' = 'Clinton',
  'North Carolina' = 'Trump', 'North Dakota' = 'Trump', 'Ohio' = 'Trump',
  'Oklahoma' = 'Trump', 'Oregon' = 'Clinton', 'Pennsylvania' = 'Trump',
  'Rhode Island' = 'Clinton', 'South Carolina' = 'Trump', 'South Dakota' = 'Trump',
  'Tennessee' = 'Trump', 'Texas' = 'Trump', 'Utah' = 'Trump', 'Vermont' = 'Clinton',
  'Virginia' = 'Clinton', 'Washington' = 'Clinton', 'West Virginia' = 'Trump',
  'Wisconsin' = 'Trump', 'Wyoming' = 'Trump'
)

# Add actual and predicted outcomes
polls$actual_winner <- state_outcomes[polls$state]
polls$predicted_winner <- ifelse(polls$adjpoll_clinton > polls$adjpoll_trump, "Clinton", "Trump")
polls$correct <- polls$predicted_winner == polls$actual_winner

# Add adjustment columns
polls <- polls %>%
  mutate(
    adj_clinton_diff = adjpoll_clinton - rawpoll_clinton,
    adj_trump_diff = adjpoll_trump - rawpoll_trump,
    abs_clinton_adj = abs(adj_clinton_diff),
    abs_trump_adj = abs(adj_trump_diff)
  )

# Bin adjustments
polls$clinton_adj_bin <- cut(polls$abs_clinton_adj, breaks = c(0, 1, 2, 3, 5, Inf),
                             labels = c("0-1%", "1-2%", "2-3%", "3-5%", "5%+"), right = FALSE)
polls$trump_adj_bin <- cut(polls$abs_trump_adj, breaks = c(0, 1, 2, 3, 5, Inf),
                           labels = c("0-1%", "1-2%", "2-3%", "3-5%", "5%+"), right = FALSE)

# Accuracy by adjustment bin
clinton_adj_accuracy <- polls %>%
  group_by(clinton_adj_bin) %>%
  summarise(
    n = n(),
    accuracy = mean(correct, na.rm = TRUE)
  )

trump_adj_accuracy <- polls %>%
  group_by(trump_adj_bin) %>%
  summarise(
    n = n(),
    accuracy = mean(correct, na.rm = TRUE)
  )

# Plot: Clinton adjustment vs accuracy
ggplot(clinton_adj_accuracy, aes(x = clinton_adj_bin, y = accuracy)) +
  geom_bar(stat = "identity", fill = "darkred") +
  ylim(0, 1) +
  labs(title = "Prediction Accuracy by Adjustment Size (Clinton)",
       x = "Adjustment Size",
       y = "Accuracy") +
  theme_minimal()

# Plot: Trump adjustment vs accuracy
ggplot(trump_adj_accuracy, aes(x = trump_adj_bin, y = accuracy)) +
  geom_bar(stat = "identity", fill = "darkblue") +
  ylim(0, 1) +
  labs(title = "Prediction Accuracy by Adjustment Size (Trump)",
       x = "Adjustment Size",
       y = "Accuracy") +
  theme_minimal()

```

```{r}
library(dplyr)
library(ggplot2)

# Assuming your dataset is already loaded as `polls` and adjustment columns exist

# Average absolute adjustment per poll
polls <- polls %>%
  mutate(
    avg_abs_adjustment = rowMeans(cbind(abs(adjpoll_clinton - rawpoll_clinton),
                                        abs(adjpoll_trump - rawpoll_trump)), na.rm = TRUE)
  )

# Group by grade
adjustment_by_grade <- polls %>%
  group_by(grade) %>%
  summarise(
    n = n(),
    avg_adjustment = mean(avg_abs_adjustment, na.rm = TRUE)
  ) %>%
  arrange(desc(avg_adjustment))

print(adjustment_by_grade)

# Plot: Grade vs. average adjustment
ggplot(adjustment_by_grade, aes(x = reorder(grade, -avg_adjustment), y = avg_adjustment)) +
  geom_bar(stat = "identity", fill = "orange") +
  labs(title = "Average Poll Adjustment vs. Poll Grade",
       x = "Pollster Grade",
       y = "Average Adjustment (%)") +
  theme_minimal()

```


```{r}
accuracy_by_size <- polls %>%
  group_by(samplesize) %>%
  summarise(
    n = n(),
    accuracy = mean(correct, na.rm = TRUE)
  )

ggplot(accuracy_by_size, aes(x = samplesize, y = accuracy)) +
  geom_point(color = "blue", alpha = 0.6) +
  geom_smooth(method = "loess", color = "red") +
  labs(title = "Prediction Accuracy vs. Poll Sample Size",
       x = "Sample Size",
       y = "Accuracy") +
  theme_minimal()

```

```{r}
library(dplyr)
library(ggplot2)

# Make sure the 'correct' column is already defined
polls$correct <- polls$predicted_winner == polls$actual_winner

# Group by sample size (using 'samplesize') and compute average accuracy
accuracy_by_size <- polls %>%
  group_by(samplesize) %>%
  summarise(
    n = n(),
    accuracy = mean(correct, na.rm = TRUE)
  ) %>%
  filter(!is.na(samplesize) & !is.na(accuracy))

# Scatter plot with fitted loess trend line
ggplot(accuracy_by_size, aes(x = samplesize, y = accuracy)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_smooth(method = "loess", se = TRUE, color = "darkred") +
  labs(title = "Poll Prediction Accuracy vs. Sample Size",
       x = "Sample Size",
       y = "Prediction Accuracy") +
  theme_minimal()

```

```{r}
ggplot(polls, aes(x = grade)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Distribution of Pollster Grades",
       x = "Pollster Grade",
       y = "Count") +
  theme_minimal()

```

```{r}
library(dplyr)
library(ggplot2)

# Calculate absolute error from raw and adjusted margins
polls_with_results <- polls %>%
  left_join(official_results, by = "state") %>%
  mutate(
    raw_margin = rawpoll_clinton - rawpoll_trump,
    adj_margin = adjpoll_clinton - adjpoll_trump,
    raw_abs_error = abs(raw_margin - true_margin),
    adj_abs_error = abs(adj_margin - true_margin)
  )

# Reshape data for comparison plot
library(tidyr)

error_long <- polls_with_results %>%
  select(state, raw_abs_error, adj_abs_error) %>%
  pivot_longer(cols = c(raw_abs_error, adj_abs_error),
               names_to = "type", values_to = "abs_error") %>%
  mutate(type = recode(type,
                       raw_abs_error = "Raw Polls",
                       adj_abs_error = "Adjusted Polls"))

# Plot: boxplot of absolute error
ggplot(error_long, aes(x = type, y = abs_error, fill = type)) +
  geom_boxplot() +
  labs(
    title = "Absolute Error of Raw vs Adjusted Polls",
    x = "Poll Type",
    y = "Absolute Margin Error (|Predicted - Actual|)"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Raw Polls" = "tomato", "Adjusted Polls" = "skyblue"))

```

```{r}
library(dplyr)
library(ggplot2)
library(readr)

# Load the dataset
polls <- read_csv("polls_us_election_2016 (1).csv")

# Mark ungraded polls
polls$grade <- ifelse(is.na(polls$grade), "Ungraded", polls$grade)

# Actual 2016 state-level outcomes
state_outcomes <- c(
  'U.S.' = 'Clinton',
  'Alabama' = 'Trump', 'Alaska' = 'Trump', 'Arizona' = 'Trump', 'Arkansas' = 'Trump',
  'California' = 'Clinton', 'Colorado' = 'Clinton', 'Connecticut' = 'Clinton',
  'Delaware' = 'Clinton', 'District of Columbia' = 'Clinton', 'Florida' = 'Trump',
  'Georgia' = 'Trump', 'Hawaii' = 'Clinton', 'Idaho' = 'Trump', 'Illinois' = 'Clinton',
  'Indiana' = 'Trump', 'Iowa' = 'Trump', 'Kansas' = 'Trump', 'Kentucky' = 'Trump',
  'Louisiana' = 'Trump', 'Maine' = 'Clinton', 'Maryland' = 'Clinton',
  'Massachusetts' = 'Clinton', 'Michigan' = 'Trump', 'Minnesota' = 'Clinton',
  'Mississippi' = 'Trump', 'Missouri' = 'Trump', 'Montana' = 'Trump',
  'Nebraska' = 'Trump', 'Nevada' = 'Clinton', 'New Hampshire' = 'Clinton',
  'New Jersey' = 'Clinton', 'New Mexico' = 'Clinton', 'New York' = 'Clinton',
  'North Carolina' = 'Trump', 'North Dakota' = 'Trump', 'Ohio' = 'Trump',
  'Oklahoma' = 'Trump', 'Oregon' = 'Clinton', 'Pennsylvania' = 'Trump',
  'Rhode Island' = 'Clinton', 'South Carolina' = 'Trump', 'South Dakota' = 'Trump',
  'Tennessee' = 'Trump', 'Texas' = 'Trump', 'Utah' = 'Trump', 'Vermont' = 'Clinton',
  'Virginia' = 'Clinton', 'Washington' = 'Clinton', 'West Virginia' = 'Trump',
  'Wisconsin' = 'Trump', 'Wyoming' = 'Trump'
)

# Add outcome and correctness
polls$actual_winner <- state_outcomes[polls$state]
polls$predicted_winner <- ifelse(polls$adjpoll_clinton > polls$adjpoll_trump, "Clinton", "Trump")
polls$correct <- polls$predicted_winner == polls$actual_winner

# Compute accuracy
grade_accuracy <- polls %>%
  group_by(grade) %>%
  summarise(
    n = n(),
    correct = sum(correct, na.rm = TRUE),
    accuracy = correct / n
  )

# Full set of grades
grade_levels <- c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "D-", "F", "Ungraded")
grade_accuracy$grade <- factor(grade_accuracy$grade, levels = grade_levels)

# Bar colors
bar_colors <- ifelse(grade_accuracy$grade == "C-", "forestgreen", "steelblue")

# Define trend line (ending at D)
trend_grades <- c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D")
trend_y <- seq(from = 0.75, to = 0.4, length.out = length(trend_grades))
trend_df <- data.frame(
  grade = factor(trend_grades, levels = grade_levels),
  trend = trend_y
)

# Plot
ggplot(grade_accuracy, aes(x = grade, y = accuracy)) +
  geom_bar(stat = "identity", aes(fill = grade), show.legend = FALSE) +
  scale_fill_manual(values = bar_colors) +
  geom_line(data = trend_df, aes(x = grade, y = trend, group = 1),
            color = "black", linetype = "dashed", size = 1.2) +
  geom_text(data = trend_df[1, ], aes(x = grade, y = trend, label = "General Expected Proportions"),
            vjust = -1, hjust = 0, color = "black", fontface = "bold.italic") +
  ylim(0, 1) +
  labs(
    title = "Which Grade had the Most Accurate Predictions?",
    x = "Pollster Grade",
    y = "Percentage Accuracy"
  ) +
  theme_minimal()


```

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(scales)

# Load the dataset
polls <- read_csv("polls_us_election_2016 (1).csv")

# Fill missing grades with the mode
mode_grade <- polls %>%
  filter(!is.na(grade)) %>%
  count(grade) %>%
  arrange(desc(n)) %>%
  slice(1) %>%
  pull(grade)

polls$grade[is.na(polls$grade)] <- mode_grade

# Define actual outcomes
state_outcomes <- c(
  'U.S.' = 'Clinton',
  'Alabama' = 'Trump', 'Alaska' = 'Trump', 'Arizona' = 'Trump', 'Arkansas' = 'Trump',
  'California' = 'Clinton', 'Colorado' = 'Clinton', 'Connecticut' = 'Clinton',
  'Delaware' = 'Clinton', 'District of Columbia' = 'Clinton', 'Florida' = 'Trump',
  'Georgia' = 'Trump', 'Hawaii' = 'Clinton', 'Idaho' = 'Trump', 'Illinois' = 'Clinton',
  'Indiana' = 'Trump', 'Iowa' = 'Trump', 'Kansas' = 'Trump', 'Kentucky' = 'Trump',
  'Louisiana' = 'Trump', 'Maine' = 'Clinton', 'Maryland' = 'Clinton',
  'Massachusetts' = 'Clinton', 'Michigan' = 'Trump', 'Minnesota' = 'Clinton',
  'Mississippi' = 'Trump', 'Missouri' = 'Trump', 'Montana' = 'Trump',
  'Nebraska' = 'Trump', 'Nevada' = 'Clinton', 'New Hampshire' = 'Clinton',
  'New Jersey' = 'Clinton', 'New Mexico' = 'Clinton', 'New York' = 'Clinton',
  'North Carolina' = 'Trump', 'North Dakota' = 'Trump', 'Ohio' = 'Trump',
  'Oklahoma' = 'Trump', 'Oregon' = 'Clinton', 'Pennsylvania' = 'Trump',
  'Rhode Island' = 'Clinton', 'South Carolina' = 'Trump', 'South Dakota' = 'Trump',
  'Tennessee' = 'Trump', 'Texas' = 'Trump', 'Utah' = 'Trump', 'Vermont' = 'Clinton',
  'Virginia' = 'Clinton', 'Washington' = 'Clinton', 'West Virginia' = 'Trump',
  'Wisconsin' = 'Trump', 'Wyoming' = 'Trump'
)

polls$actual_winner <- state_outcomes[polls$state]
polls$predicted_winner <- ifelse(polls$adjpoll_clinton > polls$adjpoll_trump, "Clinton", "Trump")
polls$correct <- polls$predicted_winner == polls$actual_winner

# Accuracy by grade
grade_accuracy <- polls %>%
  group_by(grade) %>%
  summarise(
    n = n(),
    correct = sum(correct, na.rm = TRUE),
    accuracy = correct / n
  )

# Limit to grades A+ to D
grade_levels <- c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D")
grade_accuracy <- grade_accuracy %>%
  filter(grade %in% grade_levels)
grade_accuracy$grade <- factor(grade_accuracy$grade, levels = grade_levels)

# Assign bar colors (green C-)
bar_colors <- ifelse(grade_accuracy$grade == "C-", "forestgreen", "steelblue")

# Create a steeper declining line
trend_y <- seq(from = 0.95, to = 0.3, length.out = length(grade_levels))
trend_df <- data.frame(
  grade = factor(grade_levels, levels = grade_levels),
  trend = trend_y
)

# Plot
ggplot(grade_accuracy, aes(x = grade, y = accuracy)) +
  geom_bar(stat = "identity", aes(fill = grade), show.legend = FALSE) +
  scale_fill_manual(values = bar_colors) +
  geom_line(data = trend_df, aes(x = grade, y = trend, group = 1), color = "red", size = 1.2) +
  geom_text(data = trend_df[1, ], aes(x = grade, y = trend, label = "General Expected Proportions"),
            vjust = -1, hjust = 0, color = "red", fontface = "italic") +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  labs(
    title = "Which Grade had the Most Accurate Predictions?",
    x = "Pollster Grade",
    y = "Percentage Accuracy"
  ) +
  theme_minimal()
```


```{r}
library(dplyr)
library(ggplot2)
library(readr)

# Load dataset
polls <- read_csv("polls_us_election_2016 (1).csv")

# Filter for battleground states
swing_states <- c("Wisconsin", "Michigan", "Pennsylvania")
polls_filtered <- polls %>%
  filter(state %in% swing_states) %>%
  mutate(margin = rawpoll_clinton - rawpoll_trump)

# Plot: Raw poll lean
ggplot(polls_filtered, aes(x = margin, y = state)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(shape = 4, size = 2) +
  labs(
    title = "Who Did Raw Polls Predict to Win These Key Battleground States?",
    x = "Trump ← Margin → Clinton",
    y = NULL
  ) +
  theme_minimal() +
  xlim(-50, 50)

```

```{r}

# Filter and calculate adjusted margin
polls_filtered_adj <- polls %>%
  filter(state %in% swing_states) %>%
  mutate(margin = adjpoll_clinton - adjpoll_trump)

# Plot: Adjusted poll lean
ggplot(polls_filtered_adj, aes(x = margin, y = state)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(shape = 4, size = 2) +
  labs(
    title = "How Did Adjusted Polls Reflect Voter Preference in Key States?",
    x = "Trump ← Margin → Clinton",
    y = NULL
  ) +
  theme_minimal() +
  xlim(-50, 50)

```

